 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Colab Notebooks</title>

  <!-- style + favicon -->
  <link rel="stylesheet" href="assets/style.css" />
  <link rel="icon" href="assets/favicon.ico" />

  <!-- optional site config -->
  <script src="config.js"></script>

  <!-- Parent-page logger: collects logs posted from the iframe and lets you download them -->
  <script>
    window.__thebeLogs = [];
    function __addThebeLog(level, ...args) {
      try {
        window.__thebeLogs.push({ t: new Date().toISOString(), level, msg: args.map(String).join(' ') });
        (console[level] || console.log).apply(console, ['[iframe]'].concat(args));
      } catch {}
    }
    window.addEventListener('message', (e) => {
      if (e?.data?.source === 'thebe-iframe-log') {
        const level = e.data.level || 'log';
        const args  = e.data.args  || [];
        __addThebeLog(level, ...args);
      }
    });
    function downloadThebeLog() {
      const rows = window.__thebeLogs.map(x => `${x.t}\t${x.level}\t${x.msg}`).join('\n');
      const blob = new Blob([rows + '\n'], { type: 'text/plain' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = 'thebe-log.txt';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    }
  </script>

  
  <script>
    // Fallback if config.js didn’t load
    if (!window.SITE) {
      window.SITE = { user: 'pinklore', repo: 'My-Notebook', branch: 'main' };
      console.warn('config.js not found; using fallback SITE config.');
    }
  </script>
  

  <!-- Lite modal styles (inline so you don't have to touch style.css) -->
  <style>
    .lite-modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999}
    .lite-modal.open{display:flex}
    .lite-dialog{width:min(1100px,95vw);height:min(700px,85vh);background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);position:relative}
    .lite-iframe{width:100%;height:100%;border:0}
    .lite-close{position:absolute;top:8px;right:8px;border:0;background:#fff;padding:.45rem .7rem;border-radius:999px;box-shadow:0 1px 3px rgba(0,0,0,.15);cursor:pointer}
    .lite-help{position:absolute;left:12px;top:12px;background:#fff;padding:.35rem .6rem;border-radius:10px;font-size:.85rem;box-shadow:0 1px 3px rgba(0,0,0,.15)}
  </style>

  <script>
  async function loadList() {
    const ul = document.querySelector('#notebook-list');
    try {
      if (!window.SITE || !SITE.user || !SITE.repo) {
        ul.innerHTML = '<li>config.js missing or incomplete (need SITE.user and SITE.repo).</li>';
        return;
      }
      const user = SITE.user;
      const repo = SITE.repo;
      const branch = SITE.branch || 'main';
      const api = `https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}/contents/ipynb?ref=${encodeURIComponent(branch)}`;

      const res = await fetch(api, { headers: { 'Accept': 'application/vnd.github+json' }});
      if (!res.ok) throw new Error(`GitHub API returned ${res.status}`);
      const data = await res.json();
      const items = Array.isArray(data) ? data : [];
      ul.innerHTML = '';

      for (const it of items) {
        if (!it.name.endsWith('.ipynb')) continue;
        const base = it.name.replace(/\.ipynb$/, '');
        const htmlUrl   = `notebooks/${base}.html`;
        const colabUrl  = `https://colab.research.google.com/github/${user}/${repo}/blob/${branch}/ipynb/${encodeURIComponent(it.name)}`;
        const ghUrl     = `https://github.com/${user}/${repo}/blob/${branch}/ipynb/${encodeURIComponent(it.name)}`;
        const binderUrl = `https://mybinder.org/v2/gh/${encodeURIComponent(user)}/${encodeURIComponent(repo)}/${encodeURIComponent(branch)}?labpath=ipynb/${encodeURIComponent(it.name)}`;
        const rawUrl    = `https://raw.githubusercontent.com/${user}/${repo}/${branch}/ipynb/${encodeURIComponent(it.name)}`;

        const card = document.createElement('li'); card.className = 'card';

        const header = document.createElement('div');
        header.className = 'card-header';
        header.innerHTML = `<span class="card-title">${it.name}</span><span class="arrow">▶</span>`;
        card.appendChild(header);

        const body = document.createElement('div'); body.className = 'card-body';

        const badgesEl = document.createElement('div'); badgesEl.className = 'badges'; badgesEl.id = `badges-${base}`;
        body.appendChild(badgesEl);

        const actionsEl = document.createElement('div');
        actionsEl.className = 'card-actions';
        actionsEl.innerHTML = `
          <a class="btn" href="${htmlUrl}" target="_blank" rel="noopener">View HTML</a>
          <a class="btn" href="${colabUrl}" target="_blank" rel="noopener">
            <img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg" style="height:1.1em;vertical-align:middle" />
            <span>Open in Colab</span>
          </a>
          <a class="btn" href="${binderUrl}" target="_blank" rel="noopener">
            <img alt="Launch in Binder" src="https://mybinder.org/badge_logo.svg" style="height:1.1em;vertical-align:middle" />
            <span>Run in Binder</span>
          </a>
          <a class="btn" href="${ghUrl}" target="_blank" rel="noopener">View on GitHub</a>
        `;
        body.appendChild(actionsEl);
/*
        const liveBtn = document.createElement('button');
        liveBtn.className = 'btn live-btn'; liveBtn.dataset.target = base; liveBtn.textContent = 'Make Live';
        actionsEl.appendChild(liveBtn);
*/
       /*
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn save-btn'; saveBtn.dataset.target = base; saveBtn.textContent = 'Save to GitHub';
        actionsEl.appendChild(saveBtn);
        */

        const expandBtn = document.createElement('button');
        expandBtn.className = 'btn expand-btn'; expandBtn.dataset.target = base; expandBtn.textContent = 'Expand Preview';
        actionsEl.appendChild(expandBtn);

        const liteBtn = document.createElement('button');
        liteBtn.className = 'btn'; liteBtn.textContent = 'Run in Browser (Lite)';
        liteBtn.addEventListener('click', (e) => { e.stopPropagation(); openLiteWith(rawUrl); });
        actionsEl.appendChild(liteBtn);

        const preview = document.createElement('div');
        preview.className = 'preview-wrapper';
        preview.innerHTML = `
          <iframe class="frame" id="frame-${base}" src="${htmlUrl}" loading="lazy"></iframe>
          <aside class="toc" id="toc-${base}">
            <h3>Contents</h3>
            <div class="toc-body">Loading…</div>
          </aside>`;
        body.appendChild(preview);

        card.appendChild(body);
        ul.appendChild(card);

        header.addEventListener('click', () => {
          const arrowEl = header.querySelector('.arrow');
          const isOpen = card.classList.toggle('open');
          arrowEl.textContent = isOpen ? '▼' : '▶';
        });

        const iframe = preview.querySelector(`#frame-${base}`);
        const tocEl = preview.querySelector('.toc');
        expandBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const btn = e.currentTarget;
          const expanded = btn.dataset.expanded === '1';
          iframe.style.height = expanded ? '500px' : '1000px';
          if (tocEl) tocEl.style.height = expanded ? '500px' : '1000px';
          btn.textContent = expanded ? 'Expand Preview' : 'Collapse Preview';
          btn.dataset.expanded = expanded ? '0' : '1';
        });

        await addBadges(it, base);

        iframe.addEventListener('load', () => {
          const tocBox = preview.querySelector('.toc-body');
          const hasCode = handleIframe(iframe, tocBox);
         // const liveBtnForThis = actionsEl.querySelector(`.live-btn[data-target="${base}"]`);
      //     if (liveBtnForThis) {
         //   if (!hasCode) { liveBtnForThis.disabled = true; liveBtnForThis.title = 'No code cells detected in this notebook'; }
         //   else { liveBtnForThis.disabled = false; liveBtnForThis.removeAttribute('title'); }
        //  }
        });

    //    liveBtn.addEventListener('click', (e) => { e.stopPropagation(); initLive(e.currentTarget.dataset.target); });
      //  saveBtn.addEventListener('click', (e) => { e.stopPropagation(); saveNotebookToGitHub(e.currentTarget.dataset.target); });
      }

      if (!ul.children.length) ul.innerHTML = '<li>No notebooks found yet. Add .ipynb files to /ipynb/ and push.</li>';
    } catch (err) {
      ul.innerHTML = `<li>Could not load list. Error: ${err.message}</li>`;
    }
  }

  async function addBadges(item, base) {
    const wrap = document.getElementById(`badges-${base}`); if (!wrap) return;

    const cacheKey = `lastCommit:${SITE.user}/${SITE.repo}/${item.name}`;
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) { wrap.insertAdjacentHTML('beforeend', `<span class="badge">${cached}</span>`); return; }

    if (typeof item.size === 'number') {
      const kb = (item.size / 1024).toFixed(1) + ' KB';
      wrap.insertAdjacentHTML('beforeend', `<span class="badge">${kb}</span>`);
    }
    wrap.insertAdjacentHTML('beforeend', `<span class="badge">python</span>`);

    try {
      const pathParam = encodeURIComponent(`ipynb/${item.name}`);
      const apiUrl = `https://api.github.com/repos/${SITE.user}/${SITE.repo}/commits?path=${pathParam}&page=1&per_page=1`;
      const resp = await fetch(apiUrl, { headers: { 'Accept': 'application/vnd.github+json' } });
      if (resp.ok) {
        const commitData = await resp.json();
        const d = commitData?.[0]?.commit?.committer?.date;
        if (d) {
          const s = new Date(d).toLocaleString('en-US', { timeZone: 'America/Chicago' });
          wrap.insertAdjacentHTML('beforeend', `<span class="badge">${s}</span>`);
          sessionStorage.setItem(cacheKey, s);
          return;
        }
      }
    } catch {}
    const fallback = new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' });
    wrap.insertAdjacentHTML('beforeend', `<span class="badge">${fallback}</span>`);
  }

  function handleIframe(iframe, tocBox) {
    const doc = iframe.contentDocument || iframe.contentWindow.document;
    if (!doc) { tocBox.textContent = 'Unable to read preview.'; return false; }

    const inputSelectors = 'div.input_area, .jp-Cell .jp-InputArea';
    const hasCode = !!doc.querySelector(inputSelectors);

    try {
      const areas = doc.querySelectorAll(inputSelectors);
      areas.forEach((area) => {
        if (area.dataset.thebeAdded) return;
        area.dataset.thebeAdded = '1';
        area.setAttribute('data-executable', 'true');
        area.setAttribute('data-language', 'python');
      });
    } catch {}

    let headings = doc.querySelectorAll(
      '.text_cell_render h1, .text_cell_render h2, .text_cell_render h3, ' +
      '.jp-RenderedHTMLCommon h1, .jp-RenderedHTMLCommon h2, .jp-RenderedHTMLCommon h3, ' +
      'h1, h2, h3'
    );

    headings = Array.from(headings).filter(h => h.textContent.trim().length > 0);
    if (!headings.length) {
      tocBox.textContent = 'No headings detected.';
    } else {
      const list = document.createElement('div');
      headings.forEach((h, i) => {
        if (!h.id) h.id = 'nb-h-' + i;
        const a = document.createElement('a');
        a.href = '#' + h.id;
        a.textContent = h.textContent.trim();
        const lvl = h.tagName.toLowerCase();
        a.style.marginLeft = (lvl === 'h2' ? '12px' : lvl === 'h3' ? '24px' : '0');
        a.addEventListener('click', ev => { ev.preventDefault(); h.scrollIntoView({behavior:'smooth', block:'start'}); });
        list.appendChild(a);
      });
      tocBox.innerHTML = '';
      tocBox.appendChild(list);
    }

    const areasForCopy = doc.querySelectorAll('div.input_area');
    areasForCopy.forEach(area => {
      if (area.querySelector('.nb-copy-btn')) return;
      area.style.position = area.style.position || 'relative';
      const btn = doc.createElement('button');
      btn.className = 'nb-copy-btn';
      btn.textContent = 'Copy';
      btn.style.cssText = 'position:absolute;right:8px;top:8px;font-size:12px;border:1px solid #ccc;background:#f6f6f6;padding:2px 6px;border-radius:4px;cursor:pointer;';
      btn.addEventListener('click', async () => {
        const pre = area.querySelector('pre');
        const text = pre ? pre.innerText : '';
        try { await navigator.clipboard.writeText(text); btn.textContent = 'Copied!'; }
        catch { btn.textContent = 'Failed'; }
        setTimeout(() => (btn.textContent = 'Copy'), 1200);
      });
      area.appendChild(btn);
    });

    return hasCode;
  }

  document.addEventListener('DOMContentLoaded', loadList);

  // Make Live: inject Thebe (CDN) into the iframe and bootstrap there
  async function initLive(baseName) {
    const iframe = document.getElementById('frame-' + baseName);
    const doc = iframe?.contentDocument || iframe?.contentWindow?.document;
    if (!doc) { alert('Preview not ready.'); return; }
    if (doc.body.dataset.thebeBootstrapped === '1') { console.log('[thebe] already bootstrapped for', baseName); return; }

    const inputSelectors = 'div.input_area, .jp-Cell .jp-InputArea';
    const candidates = doc.querySelectorAll(inputSelectors);
    if (!candidates.length) { alert('No code cells found in this notebook.'); return; }
    candidates.forEach(area => {
      if (!area.dataset.executable) area.setAttribute('data-executable', 'true');
      if (!area.dataset.language)   area.setAttribute('data-language', 'python');
    });
    

    // Always load Thebe from CDN (no local 404s)
    const thebeCDN = 'https://cdn.jsdelivr.net/npm/thebe@0.9.2/lib/index.js';
    await new Promise((resolve, reject) => {
      const s = doc.createElement('script');
      s.src = thebeCDN;
      s.onload = resolve;
      s.onerror = () => reject(new Error('Failed to load Thebe CDN'));
      doc.head.appendChild(s);
    });
    if (!doc.defaultView.thebe?.bootstrap) { alert('Thebe loaded, but no bootstrap() found.'); return; }
    console.log('[thebe] version', doc.defaultView.thebe?.version || '(unknown)');

    // Disable saved sessions + clear any old ones (prevents CORS with old hubs)
    try {
      const ls = doc.defaultView.localStorage;
      Object.keys(ls).forEach(k => { if (k.startsWith('thebe-binder')) ls.removeItem(k); });
    } catch {}
    // Configure Thebe
    doc.defaultView.thebe_config = {
      binderOptions: {
        repo: `${SITE.user}/${SITE.repo}`,
        ref: SITE.branch || 'main',
        binderUrl: 'https://mybinder.org',
        repoProvider: 'github'
      },
      selector: '[data-executable]',
      requestKernel: true,
      useBinderSplash: false,
      kernelName: 'python3',
      kernelOptions: { name: 'python3', path: 'ipynb' },
      savedSessions: { enabled: false }   // <— important
    };

    // Status panel + relay to parent
    (function addThebeStatusPanel() {
      const panel = doc.createElement('div');
      panel.id = 'thebe-status-panel';
      panel.style.cssText = 'position:fixed;bottom:8px;left:8px;background:#111;color:#fff;font:12px/1.3 system-ui;padding:8px 10px;border-radius:8px;opacity:.85;z-index:99999;max-width:60ch;pointer-events:none';
      panel.textContent = 'Thebe: initializing…';
      doc.body.appendChild(panel);
    })();
    function thebeLog(msg, level='log') {
      const el = doc.getElementById('thebe-status-panel');
      if (el) el.textContent = 'Thebe: ' + msg;
      try { doc.defaultView.parent.postMessage({ source:'thebe-iframe-log', level, args:['Thebe:', msg] }, '*'); } catch {}
    }

    function getThebeButtons() {
      const btns = Array.from(doc.querySelectorAll('button'));
      return btns.filter(b => /^(run|run all|restart|restart & run all)$/i.test(b.textContent.trim()));
    }
    function lockThebeButtons() {
      getThebeButtons().forEach(b => { b.disabled = true; b.title = 'Kernel is starting…'; });
      if (!doc.getElementById('thebe-disable-style')) {
        const style = doc.createElement('style');
        style.id = 'thebe-disable-style';
        style.textContent = `button[disabled]{opacity:.5;pointer-events:none}`;
        doc.head.appendChild(style);
      }
    }
    function unlockThebeButtons() { getThebeButtons().forEach(b => { b.disabled = false; b.title = ''; }); }

    lockThebeButtons();

    // Listen to status (if available)
    let kernelReadyFlag = false;
    const waitForThebe = () => new Promise((resolve) => {
      const t = doc.defaultView.thebe;
      if (!t || !t.on) return resolve();
      t.on('status', (evt) => {
        const s = typeof evt === 'string' ? evt : (evt?.status || '');
        if (s) thebeLog(s);
        if (s && /(connected|ready|idle)/i.test(s)) { kernelReadyFlag = true; unlockThebeButtons(); }
      });
      try { t.on('error', (e) => thebeLog('error: ' + (e?.message || e), 'error')); } catch {}
      resolve();
    });

    try {
      await waitForThebe();
      const start = Date.now();
      thebeLog('starting kernel (via Binder)…');

      await doc.defaultView.thebe.bootstrap();
      doc.body.dataset.thebeBootstrapped = '1';
      thebeLog('bootstrap ok; waiting for ready');

      // Poll for kernel ready (3 min)
      let ready = false;
      const t0 = Date.now();
      const deadline = Date.now() + 180000;
      while (Date.now() < deadline) {
        if (kernelReadyFlag) { ready = true; break; }
        const t = doc.defaultView.thebe;
        try {
          if (t?.kernels?.size > 0) {
            for (const k of t.kernels.values()) {
              if (k?.ready || /^(connected|idle)$/i.test(k?.status || '')) { ready = true; break; }
            }
          }
        } catch {}
        if (ready) break;
        await new Promise(r => setTimeout(r, 1000));
        thebeLog(`waiting for kernel… ${Math.round((Date.now()-t0)/1000)}s`);
      }

      if (!ready) {
        thebeLog('timeout waiting for kernel (opening Binder Lab)…');
        const owner = SITE.user, repo = SITE.repo, ref = SITE.branch || 'main';
        const nbPath = `ipynb/${baseName}.ipynb`;
        const binderLab = `https://mybinder.org/v2/gh/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/${encodeURIComponent(ref)}?labpath=${encodeURIComponent(nbPath)}`;
        setTimeout(() => { doc.defaultView.open(binderLab, '_blank'); }, 500);
        alert('Binder is slow or blocked. Opened full Binder Lab in a new tab.');
        lockThebeButtons();
      } else {
        thebeLog(`kernel ready! (in ${((Date.now() - start)/1000).toFixed(1)}s) You can Run/Restart now.`);
        unlockThebeButtons();
        console.log('[thebe] kernel ready for', baseName, 'in', ((Date.now()-start)/1000).toFixed(1), 's');
      }
    } catch (e) {
      console.error(e);
      thebeLog('bootstrap failed.', 'error');
      alert('Failed to start Thebe (Binder). Check network/Binder status.');
    }
  }


   /*
  // Save back to GitHub
  async function saveNotebookToGitHub(baseName) {
    try {
      const token = prompt('Enter your GitHub Personal Access Token (PAT) with repo write access:');
      if (!token) { alert('Save cancelled. No token provided.'); return; }
      const owner = SITE.user, repo = SITE.repo, branch = SITE.branch || 'main';
      const filename = `${baseName}.ipynb`, path = `ipynb/${filename}`;

      const metaResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
        headers: { 'Accept': 'application/vnd.github+json', 'Authorization': `Bearer ${token}` }
      });
      if (!metaResp.ok) throw new Error('Failed to fetch notebook metadata.');
      const meta = await metaResp.json(); const sha = meta.sha;

      const bin = Uint8Array.from(atob(meta.content.replace(/\n/g, '')), c => c.charCodeAt(0));
      const originalContent = new TextDecoder('utf-8').decode(bin);
      let nb = JSON.parse(originalContent);

      const updatedBytes = new TextEncoder().encode(JSON.stringify(nb, null, 1));
      let updatedBase64 = '';
      for (let i = 0; i < updatedBytes.length; i += 0x8000) {
        updatedBase64 += btoa(String.fromCharCode.apply(null, updatedBytes.subarray(i, i + 0x8000)));
      }

      const putResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Accept': 'application/vnd.github+json',
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: `Update ${filename} via interactive site`, content: updatedBase64, sha, branch })
      });
      if (!putResp.ok) throw new Error('Failed to commit notebook.');

      alert(`Notebook ${filename} saved successfully to GitHub.`);
      const iframe = document.getElementById(`frame-${baseName}`); if (iframe) iframe.src = iframe.src;

    } catch (err) {
      console.error(err);
      alert(err.message || 'An error occurred while saving the notebook.');
    }
  }
  */

  // ----- JupyterLite modal helpers -----
  function ensureLiteModal() {
    let modal = document.getElementById('lite-modal');
    if (modal) return modal;

    modal = document.createElement('div');
    modal.id = 'lite-modal';
    modal.className = 'lite-modal';
    modal.innerHTML = `
  <div class="lite-dialog">
    <button class="lite-close" aria-label="Close">✕</button>
    <div class="lite-help">
      <button class="lite-help-close" aria-label="Hide tip">✕</button>
      JupyterLite opened. Tip: drag & drop your .ipynb, or
      <b>File → Open from URL</b> (URL already copied to your clipboard).
    </div>
    <iframe class="lite-iframe" src="about:blank"></iframe>
  </div>`;

    const help = modal.querySelector('.lite-help');
    const helpClose = modal.querySelector('.lite-help-close');
    helpClose.addEventListener('click', () => { help.style.display = 'none'; });
    setTimeout(() => { help.style.display = 'none'; }, 6000);

    document.body.appendChild(modal);

    modal.querySelector('.lite-close').addEventListener('click', () => modal.classList.remove('open'));
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('open'); });
    return modal;
  }

  function openLiteWith(rawUrl) {
    const modal = ensureLiteModal();
    const iframe = modal.querySelector('iframe');
    iframe.src = 'https://jupyterlite.github.io/demo/lab/index.html';
    modal.classList.add('open');
    if (navigator.clipboard?.writeText) { navigator.clipboard.writeText(rawUrl).catch(() => {}); }
  }
  // ----- end JupyterLite helpers -----
  </script>
</head>
<body>
  <header>
    <h1>My Colab Notebooks</h1>
    <p>hi.</p>
//testing area
   <iframe style="border: 1px solid rgba(0, 0, 0, 0.1);" width="800" height="450" src="https://embed.figma.com/proto/gipEHTedYlWaDLE64PG1EQ/Untitled?node-id=1-399&scaling=min-zoom&content-scaling=fixed&page-id=0%3A1&embed-host=share" allowfullscreen></iframe>
    //done test
  </header>
  <main>
    <ul id="notebook-list" class="grid"></ul>
  </main>
  <footer>
    <p>Powered by GitHub Pages & nbconvert.</p>
  </footer>

  <!-- Download log button (fixed at bottom-right) -->
  <button onclick="downloadThebeLog()" style="position:fixed;right:12px;bottom:12px;padding:.45rem .7rem;border-radius:10px;border:1px solid #ccc;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.15);z-index:99999">Download Thebe Log</button>
</body>
</html>
