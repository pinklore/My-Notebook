<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Colab Notebooks</title>
  <link rel="stylesheet" href="assets/style.css" />
  <script defer src="config.js"></script>

  <!-- Thebe is served locally from your repo -->
  <script src="assets/thebe.js"></script>

  <script>
  async function loadList() {
    const ul = document.querySelector('#notebook-list');
    try {
      const user = SITE.user;
      const repo = SITE.repo;
      const branch = SITE.branch || 'main';
      const api = `https://api.github.com/repos/${user}/${repo}/contents/ipynb?ref=${branch}`;
      const res = await fetch(api, { headers: { 'Accept': 'application/vnd.github+json' }});
      if (!res.ok) throw new Error(`GitHub API returned ${res.status}`);
      const data = await res.json();
      const items = Array.isArray(data) ? data : [];
      ul.innerHTML = '';

      for (const it of items) {
        if (!it.name.endsWith('.ipynb')) continue;
        const base = it.name.replace(/\.ipynb$/, '');
        const htmlUrl   = `notebooks/${base}.html`;
        const colabUrl  = `https://colab.research.google.com/github/${user}/${repo}/blob/${branch}/ipynb/${encodeURIComponent(it.name)}`;
        const ghUrl     = `https://github.com/${user}/${repo}/blob/${branch}/ipynb/${encodeURIComponent(it.name)}`;
        const binderUrl = `https://mybinder.org/v2/gh/${user}/${repo}/${branch}?urlpath=lab/tree/ipynb/${encodeURIComponent(it.name)}`;

        // Card
        const card = document.createElement('li');
        card.className = 'card';

        // Header (collapsible)
        const header = document.createElement('div');
        header.className = 'card-header';
        header.innerHTML = `<span class="card-title">${it.name}</span><span class="arrow">▶</span>`;
        card.appendChild(header);

        // Body
        const body = document.createElement('div');
        body.className = 'card-body';

        // Badges
        const badgesEl = document.createElement('div');
        badgesEl.className = 'badges';
        badgesEl.id = `badges-${base}`;
        body.appendChild(badgesEl);

        // Actions
        const actionsEl = document.createElement('div');
        actionsEl.className = 'card-actions';
        actionsEl.innerHTML = `
          <a class="btn" href="${htmlUrl}" target="_blank" rel="noopener">View HTML</a>
          <a class="btn" href="${colabUrl}" target="_blank" rel="noopener">
            <img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg" style="height:1.1em;vertical-align:middle" />
            <span>Open in Colab</span>
          </a>
          <a class="btn" href="${binderUrl}" target="_blank" rel="noopener">
            <img alt="Launch in Binder" src="https://mybinder.org/badge_logo.svg" style="height:1.1em;vertical-align:middle" />
            <span>Run in Binder</span>
          </a>
          <a class="btn" href="${ghUrl}" target="_blank" rel="noopener">View on GitHub</a>
        `;
        body.appendChild(actionsEl);

        // Live + Save buttons
        const liveBtn = document.createElement('button');
        liveBtn.className = 'btn live-btn';
        liveBtn.dataset.target = base;
        liveBtn.textContent = 'Make Live';
        actionsEl.appendChild(liveBtn);

        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn save-btn';
        saveBtn.dataset.target = base;
        saveBtn.textContent = 'Save to GitHub';
        actionsEl.appendChild(saveBtn);

        // Expand height button
        const expandBtn = document.createElement('button');
        expandBtn.className = 'btn expand-btn';
        expandBtn.dataset.target = base;
        expandBtn.textContent = 'Expand Preview';
        actionsEl.appendChild(expandBtn);

        // Preview wrapper (iframe + TOC)
        const preview = document.createElement('div');
        preview.className = 'preview-wrapper';
        preview.innerHTML = `
          <iframe class="frame" id="frame-${base}" src="${htmlUrl}" loading="lazy"></iframe>
          <aside class="toc" id="toc-${base}">
            <h3>Contents</h3>
            <div class="toc-body">Loading…</div>
          </aside>
        `;
        body.appendChild(preview);

        // Assemble
        card.appendChild(body);
        ul.appendChild(card);

        // Collapse toggle
        header.addEventListener('click', () => {
          const arrowEl = header.querySelector('.arrow');
          const isOpen = card.classList.toggle('open');
          arrowEl.textContent = isOpen ? '▼' : '▶';
        });

        // Expand height
        const iframe = preview.querySelector(`#frame-${base}`);
        expandBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const btn = e.currentTarget;
          const expanded = btn.dataset.expanded === '1';
          iframe.style.height = expanded ? '500px' : '1000px';
          preview.querySelector('.toc').style.height = expanded ? '500px' : '1000px';
          btn.textContent = expanded ? 'Expand Preview' : 'Collapse Preview';
          btn.dataset.expanded = expanded ? '0' : '1';
        });

        // Badges
        await addBadges(it, base);

        // TOC + copy buttons when iframe loads
        iframe.addEventListener('load', () => {
          const tocBox = preview.querySelector('.toc-body');
          handleIframe(iframe, tocBox);
        });

        // Live + Save handlers
        liveBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          initLive(e.currentTarget.dataset.target);
        });
        saveBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          saveNotebookToGitHub(e.currentTarget.dataset.target);
        });
      }

      if (!ul.children.length) {
        ul.innerHTML = '<li>No notebooks found yet. Add .ipynb files to /ipynb/ and push.</li>';
      }
    } catch (err) {
      ul.innerHTML = `<li>Could not load list. Error: ${err.message}</li>`;
    }
  }

  // Badges
  async function addBadges(item, base) {
    const wrap = document.getElementById(`badges-${base}`);
    if (!wrap) return;

    if (typeof item.size === 'number') {
      const kb = (item.size / 1024).toFixed(1) + ' KB';
      wrap.insertAdjacentHTML('beforeend', `<span class="badge">${kb}</span>`);
    }
    wrap.insertAdjacentHTML('beforeend', `<span class="badge">python</span>`);

    try {
      const pathParam = encodeURIComponent(`ipynb/${item.name}`);
      const apiUrl = `https://api.github.com/repos/${SITE.user}/${SITE.repo}/commits?path=${pathParam}&page=1&per_page=1`;
      const resp = await fetch(apiUrl, { headers: { 'Accept': 'application/vnd.github+json' } });
      if (resp.ok) {
        const commitData = await resp.json();
        if (Array.isArray(commitData) && commitData.length > 0) {
          const d = commitData[0]?.commit?.committer?.date;
          if (d) {
            const s = new Date(d).toLocaleString('en-US', { timeZone: 'America/Chicago' });
            wrap.insertAdjacentHTML('beforeend', `<span class="badge">${s}</span>`);
            return;
          }
        }
      }
    } catch (_) {}

    const fallback = new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' });
    wrap.insertAdjacentHTML('beforeend', `<span class="badge">${fallback}</span>`);
  }

  // Build TOC and copy buttons inside iframe
  function handleIframe(iframe, tocBox) {
    const doc = iframe.contentDocument || iframe.contentWindow.document;
    if (!doc) { tocBox.textContent = 'Unable to read preview.'; return; }

    // Mark code blocks so Thebe can activate them later
    try {
      const codeBlocks = doc.querySelectorAll('div.input_area pre, pre');
      codeBlocks.forEach((pre) => {
        if (!pre.dataset.thebeAdded) {
          pre.dataset.thebeAdded = '1';
          pre.setAttribute('data-executable', 'true');
          pre.setAttribute('data-language', 'python');
        }
      });
    } catch {}

    // TOC
    let headings = doc.querySelectorAll('.text_cell_render h1, .text_cell_render h2, .text_cell_render h3, h1, h2, h3');
    headings = Array.from(headings).filter(h => h.textContent.trim().length > 0);
    if (!headings.length) {
      tocBox.textContent = 'No headings detected.';
    } else {
      const list = document.createElement('div');
      headings.forEach((h, i) => {
        if (!h.id) h.id = 'nb-h-' + i;
        const a = document.createElement('a');
        a.href = '#' + h.id;
        a.textContent = h.textContent.trim();
        const lvl = h.tagName.toLowerCase();
        a.style.marginLeft = (lvl === 'h2' ? '12px' : lvl === 'h3' ? '24px' : '0');
        a.addEventListener('click', ev => {
          ev.preventDefault();
          const t = doc.getElementById(h.id);
          if (t) t.scrollIntoView({ behavior:'smooth', block:'start' });
        });
        list.appendChild(a);
      });
      tocBox.innerHTML = '';
      tocBox.appendChild(list);
    }

    // Copy buttons
    const blocks = doc.querySelectorAll('div.input_area pre, pre');
    blocks.forEach(pre => {
      if (pre.dataset.copyAdded) return;
      pre.dataset.copyAdded = '1';
      const btn = doc.createElement('button');
      btn.textContent = 'Copy';
      btn.style.cssText = 'position:absolute;right:8px;top:8px;font-size:12px;border:1px solid #ccc;background:#f6f6f6;padding:2px 6px;border-radius:4px;cursor:pointer;';
      const wrap = doc.createElement('div');
      wrap.style.position = 'relative';
      pre.parentNode.insertBefore(wrap, pre);
      wrap.appendChild(pre);
      wrap.appendChild(btn);
      btn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(pre.innerText);
          btn.textContent = 'Copied!';
          setTimeout(() => (btn.textContent = 'Copy'), 1200);
        } catch {
          btn.textContent = 'Failed';
          setTimeout(() => (btn.textContent = 'Copy'), 1200);
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', loadList);

  // === Make Live: inject Thebe into the iframe and bootstrap there ===
async function initLive(baseName) {
  const iframe = document.getElementById('frame-' + baseName);
  const doc = iframe?.contentDocument || iframe?.contentWindow?.document;
  if (!doc) { alert('Preview not ready.'); return; }

  // 1) Mark code blocks so Thebe can activate them
  const codeBlocks = doc.querySelectorAll('.input_area pre, pre');
  codeBlocks.forEach(el => {
    const host = el.closest('pre') || el;
    if (!host.dataset.executable) host.setAttribute('data-executable', 'true');
    if (!host.dataset.language)   host.setAttribute('data-language', 'python');
  });

  // 2) Inject thebe.js into the iframe (absolute path so it doesn't 404)
  const basePath = location.pathname.endsWith('/')
    ? location.pathname
    : location.pathname.replace(/[^/]+$/, '/');
  const thebeSrc = `${location.origin}${basePath}assets/thebe.js`;

  await new Promise((resolve, reject) => {
    if (doc.defaultView.thebe) return resolve();
    const s = doc.createElement('script');
    s.src = thebeSrc;
    s.onload = resolve;
    s.onerror = () => reject(new Error('Failed to load thebe.js inside iframe'));
    doc.head.appendChild(s);
  });

  // 3) Configure + bootstrap Thebe in the iframe context
  doc.defaultView.thebe_config = {
    binderOptions: {
      repo: `${SITE.user}/${SITE.repo}`,
      ref: SITE.branch || 'main',
      binderUrl: 'https://mybinder.org'
    },
    selector: '[data-executable]',
    requestKernel: true,
    useBinderSplash: true,
    kernelName: 'python3'
  };

  try {
    await doc.defaultView.thebe.bootstrap();
    console.log('Thebe bootstrapped inside iframe.');
  } catch (e) {
    console.error(e);
    alert('Failed to start Thebe (Binder). Check network/Binder status.');
  }
}

  // === Save back to GitHub (unchanged) ===
  async function saveNotebookToGitHub(baseName) {
    try {
      const token = prompt('Enter your GitHub Personal Access Token (PAT) with repo write access:');
      if (!token) { alert('Save cancelled. No token provided.'); return; }

      const owner = SITE.user;
      const repo = SITE.repo;
      const branch = SITE.branch || 'main';
      const filename = `${baseName}.ipynb`;
      const path = `ipynb/${filename}`;

      const metaResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
        headers: { 'Accept': 'application/vnd.github+json', 'Authorization': `Bearer ${token}` }
      });
      if (!metaResp.ok) throw new Error('Failed to fetch notebook metadata.');
      const meta = await metaResp.json();
      const sha = meta.sha;

      const originalContent = atob(meta.content.replace(/\n/g, ''));
      let nb = JSON.parse(originalContent);

      const iframe = document.getElementById(`frame-${baseName}`);
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      if (!doc) throw new Error('Unable to access iframe document for saving.');

      const codeBlocks = doc.querySelectorAll('div.input_area .CodeMirror, div.input_area pre');
      let codeIndex = 0;
      nb.cells = nb.cells.map((cell) => {
        if (cell.cell_type === 'code') {
          const codeEl = codeBlocks[codeIndex];
          let code = '';
          if (codeEl?.CodeMirror?.getValue) code = codeEl.CodeMirror.getValue();
          else code = (codeEl?.innerText) || cell.source.join('');
          codeIndex++;
          cell.source = code.split(/\n/).map((line, i, arr) => i < arr.length - 1 ? line + '\n' : line);
        }
        return cell;
      });

      const updatedJSON = JSON.stringify(nb, null, 1);
      const updatedBase64 = btoa(unescape(encodeURIComponent(updatedJSON)));

      const putResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Accept': 'application/vnd.github+json',
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: `Update ${filename} via interactive site`, content: updatedBase64, sha, branch })
      });
      if (!putResp.ok) throw new Error('Failed to commit notebook.');

      alert(`Notebook ${filename} saved successfully to GitHub.`);
      iframe.src = iframe.src;
    } catch (err) {
      console.error(err);
      alert(err.message || 'An error occurred while saving the notebook.');
    }
  }
  </script>
</head>
<body>
  <header>
    <h1>My Colab Notebooks</h1>
    <p>Static HTML previews plus one-click launch in Colab.</p>
  </header>
  <main>
    <ul id="notebook-list" class="grid"></ul>
  </main>
  <footer>
    <p>Powered by GitHub Pages & nbconvert.</p>
  </footer>
</body>
</html>
