<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Notebooks</title>
  <link rel="stylesheet" href="assets/style.css" />
  <link rel="icon" href="assets/favicon.ico" />
  <script src="config.js"></script>
  <style>
    .toolbar{display:flex;gap:.5rem;align-items:center;margin:.5rem 0}
    .btn{padding:.45rem .7rem;border:1px solid #ddd;border-radius:.5rem;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .status{font-size:.9rem;opacity:.7}
    .grid{list-style:none;margin:0;padding:0;display:grid;gap:14px}
    .card{background:#fff;border:1px solid #f0d1de;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.05);padding:14px}
    .card-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .card-title{font-weight:600}
    .iframe-wrap{position:relative;border:1px solid #eee;border-radius:10px;overflow:hidden}
    .iframe-wrap iframe{width:100%;height:600px;border:0;background:#fff}
  </style>
</head>
<body>
  <header class="site-header">
    <h1>My Notebooks</h1>
    <p>Static preview, plus a Run button that executes code via Binder. Cells are read‑only.</p>
  </header>

  <main>
    <ul id="notebook-list" class="grid"></ul>
  </main>

  <script>
    async function loadList() {
      const ul = document.querySelector('#notebook-list');
      ul.innerHTML = '<li>Loading notebooks…</li>';
      try {
        const user = SITE.user, repo = SITE.repo, branch = SITE.branch || 'main';
        const api = `https://api.github.com/repos/${user}/${repo}/contents/ipynb?ref=${encodeURIComponent(branch)}`;
        const res = await fetch(api, {headers:{'Accept':'application/vnd.github+json'}});
        if(!res.ok) throw new Error('GitHub API failed: '+res.status);
        const items = (await res.json()).filter(x => x.name.endsWith('.ipynb'));
        if(!items.length){ ul.innerHTML = '<li>No .ipynb files in /ipynb</li>'; return; }
        ul.innerHTML = '';
        items.forEach(item => ul.appendChild(makeCard(item)));
      } catch(err) {
        ul.innerHTML = `<li style="color:#b00020">Error: ${err.message}</li>`;
      }
    }

    function makeCard(item){
      const base = item.name.replace(/\.ipynb$/,'');
      const htmlUrl = `notebooks/${encodeURIComponent(base)}.html`;
      const li = document.createElement('li'); li.className = 'card';

      const head = document.createElement('div'); head.className='card-header';
      head.innerHTML = `<span class="card-title">${item.name}</span>`;
      li.appendChild(head);

      const tools = document.createElement('div'); tools.className='toolbar';
      const runBtn = button('Run', async () => runNotebook(base));
      const restartBtn = button('Restart kernel', () => restartKernel(base));
      restartBtn.disabled = true;
      const status = document.createElement('span'); status.className='status'; status.textContent = '';
      tools.append(runBtn, restartBtn, status);
      li.appendChild(tools);

      const wrap = document.createElement('div'); wrap.className='iframe-wrap';
      const iframe = document.createElement('iframe');
      iframe.id = `frame-${base}`;
      iframe.src = htmlUrl;
      wrap.appendChild(iframe);
      li.appendChild(wrap);

      // store refs
      li.dataset.base = base;
      li._runBtn = runBtn;
      li._restartBtn = restartBtn;
      li._status = status;

      return li;
    }

    function button(label, onClick){
      const b = document.createElement('button');
      b.className='btn';
      b.textContent = label;
      b.addEventListener('click', onClick);
      return b;
    }

    const state = {}; // per-notebook kernel handles

    async function runNotebook(base){
      const card = [...document.querySelectorAll('.card')].find(c => c.dataset.base===base);
      const setStatus = t => card._status.textContent = t;
      card._runBtn.disabled = true; setStatus('starting kernel…');

      const iframe = document.getElementById('frame-'+base);
      const doc = iframe?.contentDocument || iframe?.contentWindow?.document;
      if(!doc){ setStatus('preview not ready'); card._runBtn.disabled=false; return; }

      // mark code cells executable and read-only
      const inputAreas = doc.querySelectorAll('div.input_area, .jp-Cell .jp-InputArea, pre');
      let count = 0;
      inputAreas.forEach(area=>{
        const code = area.querySelector('pre, code, .highlight>pre') || area;
        if(!code) return;
        // thebe looks for <pre> or code blocks with data-executable
        if(code.tagName !== 'PRE'){
          const pre = doc.createElement('pre');
          pre.textContent = code.textContent;
          area.replaceWith(pre);
          pre.setAttribute('data-executable','true');
          pre.setAttribute('data-language','python');
          count++;
        } else {
          code.setAttribute('data-executable','true');
          code.setAttribute('data-language','python');
          count++;
        }
      });
      if(!count){ setStatus('no code cells found'); card._runBtn.disabled=false; return; }

      // inject thebe
      await injectScript(doc, 'https://cdn.jsdelivr.net/npm/thebe@0.9.2/lib/index.js');

      // clear old saved sessions (avoid stale kernels)
      try { const ls = doc.defaultView.localStorage; Object.keys(ls).forEach(k=>{ if(k.startsWith('thebe-binder')) ls.removeItem(k); }); } catch{}

      // configure thebe
      doc.defaultView.thebe_config = {
        binderOptions: {
          repo: `${SITE.user}/${SITE.repo}`,
          ref: SITE.branch || 'main',
          binderUrl: 'https://mybinder.org',
          repoProvider: 'github'
        },
        selector: '[data-executable]',
        requestKernel: true,
        useBinderSplash: false,
        kernelName: 'python3',
        kernelOptions: { name: 'python3', path: 'ipynb' },
        codeMirrorConfig: { readOnly: true },
        savedSessions: { enabled: false }
      };

      // status panel inside iframe
      const panel = doc.createElement('div');
      panel.id = 'thebe-status-panel';
      panel.style.cssText = 'position:fixed;bottom:8px;left:8px;background:#000;color:#fff;padding:6px 9px;border-radius:8px;font:12px/1.2 system-ui;opacity:.85;z-index:9999';
      panel.textContent = 'Thebe: initializing…';
      doc.body.appendChild(panel);
      const setPanel = t => { const el = doc.getElementById('thebe-status-panel'); if(el) el.textContent = 'Thebe: '+t; };

      // bootstrap
      await doc.defaultView.thebe.bootstrap();
      setStatus('connecting…'); setPanel('connecting…');

      // wait for kernel ready
      await new Promise(resolve=>{
        const t = doc.defaultView.thebe;
        if(!t || !t.on) return resolve();
        t.on('status', evt=>{
          const s = typeof evt==='string' ? evt : (evt?.status||'');
          if(s) { setStatus(s); setPanel(s); }
          if(/(connected|ready|idle)/i.test(s)) resolve();
        });
        // fallback resolve after 25s
        setTimeout(resolve, 25000);
      });

      // run all cells in sequence
      try{
        setStatus('running cells…'); setPanel('running cells…');
        await runAllThebeCells(doc);
        setStatus('done'); setPanel('done');
        card._restartBtn.disabled = false;
        state[base] = { iframe };
      } catch(err){
        setStatus('error running: '+err.message);
        card._runBtn.disabled = false;
      }
    }

    async function runAllThebeCells(doc){
      const T = doc.defaultView.thebe;
      // thebe v0.9 exposes a registry of cells once bootstrapped
      const cells = [...doc.querySelectorAll('[data-executable]')];
      for(let i=0;i<cells.length;i++){
        const c = T?.registry?.getCell?.(cells[i]) || null;
        if(c && c.run) { await c.run(); }
      }
    }

    function restartKernel(base){
      const card = [...document.querySelectorAll('.card')].find(c => c.dataset.base===base);
      const setStatus = t => card._status.textContent = t;
      setStatus('restarting kernel…');
      const iframe = document.getElementById('frame-'+base);
      const doc = iframe?.contentDocument || iframe?.contentWindow?.document;
      if(!doc){ setStatus('preview not ready'); return; }
      try {
        const T = doc.defaultView.thebe;
        if(T?.kernel) T.kernel.shutdown();
      } catch {}
      setStatus('kernel stopped'); card._restartBtn.disabled = true; card._runBtn.disabled = false;
      const panel = doc.getElementById('thebe-status-panel'); if(panel) panel.textContent = 'Thebe: stopped';
    }

    function injectScript(doc, src){
      return new Promise((resolve, reject)=>{
        const s = doc.createElement('script');
        s.src = src; s.async = true; s.onload = resolve; s.onerror = () => reject(new Error('failed to load '+src));
        doc.head.appendChild(s);
      });
    }

    loadList();
  </script>
</body>
</html>
